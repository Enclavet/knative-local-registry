apiVersion: batch/v1
kind: Job
metadata:
  name: registry-cert-cluster-ca
  namespace: registry
spec:
  backoffLimit: 4
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: bash
        image: debian:stretch-slim@sha256:40b4072ce18fabe32f357f7c9ec1d256d839b1b95bcdc1f9c910823c6c2932e9
        command:
        - /bin/sh
        args:
        - cex
        - |
          cat <<EOF | cfssl genkey - | cfssljson -bare server
          {
            "hosts": [
              "unauthenticated.registry.svc.cluster.local",
              "authenticated.registry.svc.cluster.local",
              "knative-local-registry"
            ],
            "CN": "registry.registry.svc.cluster.local",
            "key": {
              "algo": "ecdsa",
              "size": 256
            }
          }
          EOF

          cat <<EOF | kubectl create -f -
          apiVersion: certificates.k8s.io/v1beta1
          kind: CertificateSigningRequest
          metadata:
            name: private.registry
          spec:
            groups:
            - system:authenticated
            request: $(cat server.csr | base64 | tr -d '\n')
            usages:
            - digital signature
            - key encipherment
            - server auth
          EOF
          
          kubectl describe csr private.registry

echo "Now someone/somebot with sufficient rights must run"
echo "kubectl certificate approve private.registry"